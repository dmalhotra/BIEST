#include <biest.hpp>
#include <sctl.hpp>

int main(int argc, char** argv) {
#ifdef SCTL_HAVE_PETSC
  PetscInitialize(&argc, &argv, NULL, NULL);
#elif defined(SCTL_HAVE_MPI)
  MPI_Init(&argc, &argv);
#endif

  {
    typedef double Real;
    sctl::Comm comm = sctl::Comm::World();
    sctl::Profile::Enable(true);

    { // TaylorState::test_conv
      sctl::Vector<biest::Surface<Real>> Svec;
      Svec.PushBack(biest::Surface<Real>(70, 14, biest::SurfType::Quas3));

      biest::TaylorState<Real, 1,  6, 15>::test_conv(0.5, Svec,  1, 1.0e-00, 100, comm, 1e-2);
      biest::TaylorState<Real, 1, 12, 24>::test_conv(0.5, Svec,  2, 2.1e-02, 100, comm, 1e-2);
      biest::TaylorState<Real, 1, 15, 27>::test_conv(0.5, Svec,  3, 9.6e-03, 100, comm, 1e-2);
      biest::TaylorState<Real, 1, 15, 30>::test_conv(0.5, Svec,  4, 2.9e-03, 100, comm, 1e-2);
      biest::TaylorState<Real, 1, 20, 33>::test_conv(0.5, Svec,  5, 6.5e-04, 100, comm, 1e-2);
      biest::TaylorState<Real, 1, 20, 36>::test_conv(0.5, Svec,  6, 2.8e-04, 100, comm, 1e-2);
      biest::TaylorState<Real, 1, 20, 36>::test_conv(0.5, Svec,  7, 1.5e-04, 100, comm, 1e-2);
      biest::TaylorState<Real, 1, 25, 39>::test_conv(0.5, Svec,  8, 4.8e-05, 100, comm, 1e-2);
      biest::TaylorState<Real, 1, 25, 39>::test_conv(0.5, Svec,  9, 1.5e-05, 100, comm, 1e-2);
      biest::TaylorState<Real, 1, 25, 42>::test_conv(0.5, Svec, 10, 3.6e-06, 100, comm, 1e-2);
      biest::TaylorState<Real, 1, 30, 51>::test_conv(0.5, Svec, 15, 6.8e-08, 200, comm, 1e-2);
      biest::TaylorState<Real, 1, 35, 60>::test_conv(0.5, Svec, 20, 4.0e-09, 200, comm, 1e-2);
      biest::TaylorState<Real, 1, 40, 66>::test_conv(0.5, Svec, 25, 1.0e-09, 200, comm, 1e-2);

      biest::TaylorState<Real, 1,  6, 15>::test_conv(1.0, Svec,  1, 1.0e-00, 100, comm, 1e-2);
      biest::TaylorState<Real, 1, 12, 24>::test_conv(1.0, Svec,  2, 2.1e-02, 100, comm, 1e-2);
      biest::TaylorState<Real, 1, 15, 27>::test_conv(1.0, Svec,  3, 9.6e-03, 100, comm, 1e-2);
      biest::TaylorState<Real, 1, 15, 30>::test_conv(1.0, Svec,  4, 2.9e-03, 100, comm, 1e-2);
      biest::TaylorState<Real, 1, 20, 33>::test_conv(1.0, Svec,  5, 6.5e-04, 100, comm, 1e-2);
      biest::TaylorState<Real, 1, 20, 36>::test_conv(1.0, Svec,  6, 2.8e-04, 100, comm, 1e-2);
      biest::TaylorState<Real, 1, 20, 36>::test_conv(1.0, Svec,  7, 1.5e-04, 100, comm, 1e-2);
      biest::TaylorState<Real, 1, 25, 39>::test_conv(1.0, Svec,  8, 4.8e-05, 100, comm, 1e-2);
      biest::TaylorState<Real, 1, 25, 39>::test_conv(1.0, Svec,  9, 1.5e-05, 100, comm, 1e-2);
      biest::TaylorState<Real, 1, 25, 42>::test_conv(1.0, Svec, 10, 3.6e-06, 100, comm, 1e-2);
      biest::TaylorState<Real, 1, 30, 51>::test_conv(1.0, Svec, 15, 6.8e-08, 200, comm, 1e-2);
      biest::TaylorState<Real, 1, 35, 60>::test_conv(1.0, Svec, 20, 4.0e-09, 200, comm, 1e-2);
      biest::TaylorState<Real, 1, 40, 66>::test_conv(1.0, Svec, 25, 1.0e-09, 200, comm, 1e-2);


      // +----------------------------------------------------------------------------------------------------------------------------------+
      // | lambda  up  gmres_tol         N  | gmres_iter  rel_inf_error   |    Setup         LB           Quadrature                  Solve |
      // |----------------------------------|-----------------------------|-----------------------------------------------------------------|
      // |    0.5   1    1.0e-00    9.8e+2  |          2     6.9302e-01   |   0.0586     1.9949      0.0283 (23.799)       2.0818 ( 0.3896) |
      // |    0.5   2    2.1e-02    3.9e+3  |         20     9.4458e-02   |   0.5741     2.9015      1.0012 (45.194)       4.4768 (10.4597) |
      // |    0.5   3    9.6e-03    8.8e+3  |         24     2.5767e-02   |   1.6282     8.2480      4.4368 (57.427)      14.3130 (18.1394) |
      // |    0.5   4    2.9e-03    1.6e+4  |         29     7.3301e-03   |   3.5051    18.0430     13.8180 (65.510)      35.3656 (25.8742) |
      // |    0.5   5    6.5e-04    2.5e+4  |         33     2.2206e-03   |   6.9642    39.3870     36.8900 (67.815)      83.2408 (30.3113) |
      // |    0.5   6    2.8e-04    3.5e+4  |         37     8.0535e-04   |  11.5255    63.4470     78.9510 (71.282)     153.9231 (36.7850) |
      // |    0.5   7    1.5e-04    4.8e+4  |         38     3.8012e-04   |  15.7752   101.3900    143.8800 (73.235)     261.0452 (40.5430) |
      // |    0.5   8    4.8e-05    6.3e+4  |         41     1.6383e-04   |  24.7815   148.0600    266.3100 (72.896)     439.1545 (44.3890) |
      // |    0.5   9    1.5e-05    7.9e+4  |         43     4.8860e-05   |  31.6569   256.8900    434.1700 (74.130)     722.7201 (44.6748) |
      // |    0.5  10    3.6e-06    9.8e+4  |         46     2.1940e-05   |  44.7139   342.9000    693.8100 (74.752)    1081.4280 (48.0856) |
      // |    0.5  15    6.8e-08    2.2e+5  |         56     5.2658e-07   | 148.0436  1314.8000   4074.9000 (76.630)    5537.7896 (56.4689) |
      // |    0.5  20    4.0e-09    3.9e+5  |         61     3.1407e-08   | 367.2803  2803.7000  13718.0000 (77.643)   16889.0149 (63.1290) |
      // |    0.5  25    1.0e-09    6.1e+5  |         66     4.4300e-09   | 704.6091  6242.9000  35729.0000 (78.236)   42676.4985 (65.5492) |
      // |----------------------------------|-----------------------------|-----------------------------------------------------------------|
      // |    1.0   1    1.0e-00    9.8e+2  |          2     8.0376e-01   |   0.0744     2.2491      0.3275 (2.0565)       2.6510 ( 0.3060) |
      // |    1.0   2    2.1e-02    3.9e+3  |         29     1.2895e-01   |   0.5861     4.0047      1.2857 (48.655)       5.8765 (10.9153) |
      // |    1.0   3    9.6e-03    8.8e+3  |         34     3.3170e-02   |   1.6201    11.0140      5.8916 (58.970)      18.5257 (19.0164) |
      // |    1.0   4    2.9e-03    1.6e+4  |         40     1.1387e-02   |   3.4628    23.0320     18.0240 (67.233)      44.5190 (27.4422) |
      // |    1.0   5    6.5e-04    2.5e+4  |         45     2.5596e-03   |   6.8310    53.1820     48.9470 (67.920)     108.9596 (30.7096) |
      // |    1.0   6    2.8e-04    3.5e+4  |         48     1.0597e-03   |  11.6270    82.8910    100.1000 (71.502)     194.6183 (36.9536) |
      // |    1.0   7    1.5e-04    4.8e+4  |         50     4.3042e-04   |  15.7137   135.5400    184.4800 (73.645)     335.7299 (40.6078) |
      // |    1.0   8    4.8e-05    6.3e+4  |         53     1.5026e-04   |  25.2366   204.5600    335.2300 (73.538)     565.0258 (43.7728) |
      // |    1.0   9    1.5e-05    7.9e+4  |         58     6.2055e-05   |  31.5709   355.4100    568.2800 (74.921)     955.2581 (44.6776) |
      // |    1.0  10    3.6e-06    9.8e+4  |         63     2.3067e-05   |  44.1149   478.6500    921.2600 (75.647)    1444.0292 (48.3568) |
      // |    1.0  15    6.8e-08    2.2e+5  |         78     5.5402e-07   | 148.0984  1861.1000   5545.8000 (77.141)    7554.9895 (56.6864) |
      // |    1.0  20    4.0e-09    3.9e+5  |         85     2.8655e-08   | 366.1570  3894.2000  18597.0000 (78.599)   22857.3944 (63.9971) |
      // |    1.0  25    1.0e-09    6.1e+5  |         88     6.4971e-09   | 704.8676  8381.8000  46458.0000 (79.229)   55544.6841 (66.3051) |
      // +----------------------------------------------------------------------------------------------------------------------------------+
    }

    sctl::Profile::print(&comm);
  }

#ifdef SCTL_HAVE_PETSC
  PetscFinalize();
#elif defined(SCTL_HAVE_MPI)
  MPI_Finalize();
#endif
  return 0;
}

